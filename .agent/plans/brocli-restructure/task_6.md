# Task 6: Update Package.json with Bin Field and Scripts

## Overview
Update the package.json configuration to include the `bin` field for CLI distribution and update the existing scripts to use the new Brocli-based CLI structure.

## Implementation Steps

1. **Add bin field to package.json**
   Add the `bin` field to make the CLI globally installable:

```json
{
  "name": "whap",
  "description": "CLI and mock server for testing WhatsApp integration",
  "type": "module",
  "bin": {
    "whap": "./dist/index.js"
  },
  // ... rest of configuration
}
```

2. **Update scripts section**
   Replace the existing scripts to use the new CLI structure:

```json
{
  "scripts": {
    "build": "tsc",
    "start:server": "tsx src/index.ts server",
    "start:cli": "tsx src/index.ts tui",
    "start:tui": "tsx src/index.ts tui",
    "dev:server": "tsx --watch src/index.ts server",
    "dev:cli": "tsx --watch src/index.ts tui",
    "dev:tui": "tsx --watch src/index.ts tui",
    "test": "vitest run",
    "test:watch": "vitest --watch",
    "test:ui": "vitest --ui",
    "whap": "tsx src/index.ts"
  }
}
```

3. **Add TypeScript build configuration** (if not already present)
   Ensure TypeScript is configured to build to the `dist` directory:

```json
// In tsconfig.json, verify these settings exist:
{
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": "./src",
    "module": "ESNext",
    "target": "ES2022",
    "moduleResolution": "node",
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "strict": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

4. **Add development and production scripts**
   Include additional helpful scripts:

```json
{
  "scripts": {
    // ... existing scripts
    "dev": "tsx src/index.ts",
    "clean": "rm -rf dist",
    "prepublishOnly": "pnpm run clean && pnpm run build",
    "postinstall": "echo 'ðŸš€ WhatsApp CLI ready! Run \"pnpm whap --help\" to get started.'"
  }
}
```

## Complete Package.json Changes

The updated sections should look like this:

```json
{
  "name": "whap",
  "description": "CLI and mock server for testing WhatsApp integration",
  "version": "1.0.0",
  "type": "module",
  "bin": {
    "whap": "./dist/index.js"
  },
  "scripts": {
    "build": "tsc",
    "start:server": "tsx src/index.ts server",
    "start:cli": "tsx src/index.ts tui",
    "start:tui": "tsx src/index.ts tui",
    "dev:server": "tsx --watch src/index.ts server",
    "dev:cli": "tsx --watch src/index.ts tui", 
    "dev:tui": "tsx --watch src/index.ts tui",
    "dev": "tsx src/index.ts",
    "test": "vitest run",
    "test:watch": "vitest --watch",
    "test:ui": "vitest --ui",
    "whap": "tsx src/index.ts",
    "clean": "rm -rf dist",
    "prepublishOnly": "pnpm run clean && pnpm run build",
    "postinstall": "echo 'ðŸš€ WhatsApp CLI ready! Run \"pnpm whap --help\" to get started.'"
  },
  "dependencies": {
    "@drizzle-team/brocli": "^1.0.0",
    // ... existing dependencies
  }
  // ... rest of configuration remains the same
}
```

## Technical Requirements

- **Bin Field**: Points to compiled JavaScript in `dist` directory for distribution
- **Development Scripts**: Use `tsx` for direct TypeScript execution during development
- **Production Scripts**: Use compiled JavaScript for production/distribution
- **Backward Compatibility**: Maintain existing script names where possible
- **Build Process**: Ensure TypeScript compilation works correctly

## Script Usage Examples

### Development (TypeScript execution)
```bash
# Development commands (use tsx for direct execution)
pnpm run start:server    # tsx src/index.ts server
pnpm run start:cli       # tsx src/index.ts tui
pnpm run dev:server      # tsx --watch src/index.ts server

# Generic development command
pnpm run dev             # tsx src/index.ts (shows help)
```

### Production (Compiled JavaScript)
```bash
# Build the project
pnpm run build

# Run compiled version
node dist/index.js server
node dist/index.js tui

# After installation, use globally
whap server
whap tui
whap --help
```

### Using pnpm directly
```bash
# During development, can use pnpm whap
pnpm whap server
pnpm whap tui
pnpm whap --help
```

## File Structure Impact

```
project/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts          # Main CLI entry (source)
â”‚   â”œâ”€â”€ commands/
â”‚   â””â”€â”€ ...
â”œâ”€â”€ dist/                 # Generated by TypeScript compiler
â”‚   â”œâ”€â”€ index.js          # Main CLI entry (compiled)
â”‚   â”œâ”€â”€ commands/
â”‚   â””â”€â”€ ...
â””â”€â”€ package.json          # Updated with bin field
```

## Installation and Distribution

After these changes:

1. **Local Development**: Use `pnpm run start:server` or `pnpm whap server`
2. **Global Installation**: 
   ```bash
   npm install -g whap
   whap server  # Works globally
   ```
3. **Package Distribution**: The `bin` field enables npm/pnpm package distribution

## Validation Steps

1. **Script execution**:
   ```bash
   pnpm run start:server  # Should start server
   pnpm run start:cli     # Should start TUI
   ```

2. **Direct CLI usage**:
   ```bash
   pnpm whap --help       # Should show help
   pnpm whap server       # Should start server
   pnpm whap tui          # Should start TUI
   ```

3. **Build process**:
   ```bash
   pnpm run build        # Should compile successfully
   node dist/index.js --help  # Should work with compiled version
   ```

4. **Package structure**:
   ```bash
   pnpm pack             # Should create a valid package
   ```

## Notes

- The `bin` field points to compiled JavaScript for distribution
- Development scripts use `tsx` for convenience (no compilation step)
- The `prepublishOnly` script ensures clean builds for distribution
- All script names maintain backward compatibility where possible
- The `postinstall` message provides helpful user guidance

## Dependencies

- TypeScript compiler (`tsc`)
- TSX for development execution
- Existing build tools

## Next Steps

After completion, proceed to [Task 7: Test server command functionality](./task_7.md)

## Completion Notes
<!-- Fill out this section when the task is completed -->

**Completion Date:** [Date]

**Implementation Summary:**
[Brief summary of what was implemented]

**Challenges Encountered:**
- [Challenge 1]
- [Challenge 2]

**Lessons Learned:**
- [Lesson 1]
- [Lesson 2]

**Follow-up Items:**
- [ ] [Any follow-up task 1]
- [ ] [Any follow-up task 2]